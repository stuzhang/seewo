name: Build Windows App

# 触发条件
on:
  # 手动触发
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: 1.0.0)'
        required: false
        default: '1.0.0'
        type: string
  
  # 推送到main分支时触发
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'package.json'
      - 'vite.config.ts'
  
  # PR到main分支时触发
  pull_request:
    branches: [ main ]

# 环境变量
env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    # 检出代码
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 设置Node.js环境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    # 安装pnpm
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
    
    # 安装依赖
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    # 构建前端应用
    - name: Build frontend
      run: pnpm run build
    
    # 构建Electron应用
    - name: Build Electron app
      run: pnpm run electron:build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 上传构建产物
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-${{ github.sha }}
        path: |
          dist-electron/*.exe
          dist-electron/*.msi
          dist-electron/*.zip
        retention-days: 30
    
    # 创建Release（仅在手动触发或推送tag时）
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version || '1.0.0' }}
        name: Release v${{ github.event.inputs.version || '1.0.0' }}
        body: |
          ## 🚀 新版本发布
          
          ### 📦 下载
          - Windows 安装包: `*.exe`
          - Windows MSI 安装包: `*.msi`
          - Windows 便携版: `*.zip`
          
          ### 🔧 系统要求
          - Windows 10 或更高版本
          - .NET Framework 4.7.2 或更高版本
          
          ### 📝 更新内容
          请查看提交历史了解详细更新内容。
        files: |
          dist-electron/*.exe
          dist-electron/*.msi
          dist-electron/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}