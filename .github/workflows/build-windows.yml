name: Build Windows App

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: false
        default: '1.0.0'
        type: string
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'electron/**'
      - 'package.json'
      - 'vite.config.ts'
  
  # PRåˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # è®¾ç½®Node.jsç¯å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    # å®‰è£…pnpm
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
    
    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    # æ„å»ºå‰ç«¯åº”ç”¨
    - name: Build frontend
      run: pnpm run build
    
    # æ„å»ºElectronåº”ç”¨
    - name: Build Electron app
      run: pnpm run electron:build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-${{ github.sha }}
        path: |
          dist-electron/*.exe
          dist-electron/*.msi
          dist-electron/*.zip
        retention-days: 30
    
    # åˆ›å»ºReleaseï¼ˆä»…åœ¨æ‰‹åŠ¨è§¦å‘æˆ–æ¨é€tagæ—¶ï¼‰
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version || '1.0.0' }}
        name: Release v${{ github.event.inputs.version || '1.0.0' }}
        body: |
          ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          ### ğŸ“¦ ä¸‹è½½
          - Windows å®‰è£…åŒ…: `*.exe`
          - Windows MSI å®‰è£…åŒ…: `*.msi`
          - Windows ä¾¿æºç‰ˆ: `*.zip`
          
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET Framework 4.7.2 æˆ–æ›´é«˜ç‰ˆæœ¬
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        files: |
          dist-electron/*.exe
          dist-electron/*.msi
          dist-electron/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}